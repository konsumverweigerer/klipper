# Config for extruder testing
[stepper_x]
step_pin: PF0
dir_pin: PF1
enable_pin: !PD7
microsteps: 16
rotation_distance: 40
endstop_pin: ^PE5
position_endstop: 0
position_max: 200
homing_speed: 50

[stepper_y]
step_pin: PF6
dir_pin: !PF7
enable_pin: !PF2
microsteps: 16
rotation_distance: 40
endstop_pin: ^PJ1
position_endstop: 0
position_max: 200
homing_speed: 50

[stepper_z]
step_pin: PL3
dir_pin: PL1
enable_pin: !PK0
microsteps: 16
rotation_distance: 8
endstop_pin: ^PD3
position_endstop: 0.5
position_max: 200

[extruder]
step_pin: PA4
dir_pin: PA6
enable_pin: !PA2
microsteps: 16
rotation_distance: 32
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PB4
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK5
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
min_temp: 0
max_temp: 210

[extruder_stepper extruder1]
extruder: #extruder
step_pin: PH5
dir_pin: PH6
enable_pin: !PB5
microsteps: 16
rotation_distance: 32

[extruder_stepper extruder2]
extruder: #extruder
step_pin: PH3
dir_pin: PH4
enable_pin: !PB6
microsteps: 16
rotation_distance: 32

[mixing_extruder]
steppers: extruder, extruder1, extruder2

[mcu]
serial: /dev/ttyACM0

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100


[gcode_macro M163]
gcode:
    SET_MIXING_EXTRUDER STEPPER={params.S} SCALE={params.P}

[gcode_macro M164]
gcode:
    SAVE_MIXING_EXTRUDERS EXTRUDER={params.S|default(ACTIVE)}

[gcode_macro M165]
gcode:
    SET_MIXING_EXTRUDER STEPPER=0 SCALE={params.A|default(0)|float}
    SET_MIXING_EXTRUDER STEPPER=1 SCALE={params.B|default(0)|float}}
    SET_MIXING_EXTRUDER STEPPER=2 SCALE={params.C|default(0)|float}}
    SAVE_MIXING_EXTRUDERS EXTRUDER=ACTIVE

[gcode_macro M166]
gcode:
    {% if params.A|float > 0 and params.Z|float > 0 and params.I|int >= 0 and params.J|int >= 0 %}
      ADD_MIXING_GRADIENT EXTRUDER={params.T|default(ACTIVE)} START_HEIGHT={params.A} END_HEIGHT={params.Z} START={params.I} END={params.J}
      SET_MIXING_GRADIENT EXTRUDER={params.T|default(ACTIVE)} ENABLE={params.S|default(RESET)}
    {% elif params.S != "RESET" %}
      SET_MIXING_GRADIENT EXTRUDER={params.T|default(ACTIVE)} ENABLE={params.S|default(RESET)}
    {% else %}
      RESET_MIXING_GRADIENT EXTRUDER={params.T|default(ACTIVE)}
    {% endif %}

[gcode_macro M567]
gcode:
    {% set weights = ((params.E|default("1:0:0"))+":0:0").split(":") %}
    SET_MIXING_EXTRUDER STEPPER=0 SCALE={weights[0]}
    SET_MIXING_EXTRUDER STEPPER=1 SCALE={weights[1]}
    SET_MIXING_EXTRUDER STEPPER=2 SCALE={weights[2]}
    SAVE_MIXING_EXTRUDERS EXTRUDER={params.P|default(ACTIVE)}

[gcode_macro G1]
rename_existing: G1.1
gcode:
    {% set xyzf = ("X%s Y%s Z%s F%s "%(params.X, params.Y, params.Z, params.F)).replace("X ", "").replace("Y ", "").replace("Z ", "").replace("F ", "") %}
    {% if (params.E|default("!")).find("!") >= 0 %}
      G1.1 {xyzf}
    {% elif (params.E|default("0")).find(":") < 0 %}
      G1.1 {xyzf} E{params.E|default("0")}
    {% else %}
      {% set weights = ((params.E|default("0:0:0"))+":0:0").split(":") %}
      {% set e_sum = weights[0]|float+weights[1]|float+weights[2]|float %}
      SET_MIXING_EXTRUDER STEPPER=0 SCALE={weights[0]|float/e_sum}
      SET_MIXING_EXTRUDER STEPPER=1 SCALE={weights[1]|float/e_sum}
      SET_MIXING_EXTRUDER STEPPER=2 SCALE={weights[2]|float/e_sum}
      SAVE_MIXING_EXTRUDERS
      SAVE_GCODE_STATE NAME=_mixing_g1_state
      M83
      G1.1 {xyzf} E{e_sum}
      RESTORE_GCODE_STATE NAME=_mixing_g1_state
    {% endif %}

[gcode_macro G10]
gcode:
    {% set retract_length = printer['firmware_retraction'].retract_length %}
    {% set retract_speed = printer['firmware_retraction'].retract_length %}
    SAVE_GCODE_STATE NAME=_mixing_retract_state
    M83
    G1 E{-(retract_length|float)/3}:{-(retract_length|float)/3}}:{-(retract_length|float)/3}} F{retract_speed|float}
    RESTORE_GCODE_STATE NAME=_mixing_retract_state

[gcode_macro G11]
gcode:
    {% set retract_length = printer['firmware_retraction'].retract_length %}
    {% set retract_speed = printer['firmware_retraction'].retract_length %}
    SAVE_GCODE_STATE NAME=_mixing_retract_state
    M83
    G1 E{(retract_length|float)/3}:{(retract_length|float)/3}}:{(retract_length|float)/3}} F{retract_speed|float}
    RESTORE_GCODE_STATE NAME=_mixing_retract_state


[gcode_macro Check_Stepper_Pos]
gcode:
    {% set tics = printer['mixing_extruder'].mixing_ticks.split(",") %}
    {% set pos_A = params.A|default("x") %}
    {% set pos_B = params.B|default("x") %}
    {% set pos_C = params.C|default("x") %}
    {% if pos_A != "x" %}
      {% if tics[0] == pos_A %}
        {action_respond_info("Position A matches expectation %s"%(pos_A))}
      {% else %}
        {action_raise_error("Wrong A position %s/%s"%(tics[0], pos_A))}
      {% endif %}
    {% endif %}
    {% if pos_B != "x" %}
      {% if tics[1] == pos_B %}
        {action_respond_info("Position B matches expectation %s"%(pos_B))}
      {% else %}
        {action_raise_error("Wrong B position %s/%s"%(tics[1], pos_B))}
      {% endif %}
    {% endif %}
    {% if pos_C != "x" %}
      {% if tics[2] == pos_C %}
        {action_respond_info("Position C matches expectation %s"%(pos_C))}
      {% else %}
        {action_raise_error("Wrong C position %s/%s"%(tics[2], pos_C))}
      {% endif %}
    {% endif %}
