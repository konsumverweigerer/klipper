[include fluidd.cfg]
# This file contains common pin mappings for the GTM32 PRO board in the Geeetech 301 printer
# To use this config, the firmware should be compiled for the
# STM32F103 with "No bootloader" and with "Use USB for communication"
# disabled.

# See docs/Config_Reference.md for a description of parameters.

[board_pins gtm32_pro_vb]
aliases: X_MIN=PE5,X_MAX=PE4,Y_MIN=PE3,Y_MAX=PE2,Z_MIN=PE1,Z_MAX=PE0,E0_TEMP=PC0,T0_PWM=PB4,E1_TEMP=PC1,T1_PWM=PB5,E2_TEMP=PC2,T2_PWM=PB0,BED_TEMP=PC3,BED_PWM=PB1,FAN0_PWM=PB7,FAN1_PWM=PB8,FAN2_PWM=PB9,BEEP=PB10,LED_PWM=PD12,X_EN=PA8,X_DIR=PD13,X_STEP=PC6,Y_EN=PA15,Y_DIR=PA11,Y_STEP=PA12,Z_EN=PB3,Z_DIR=PD3,Z_STEP=PD6,E0_EN=PC15,E0_DIR=PC13,E0_STEP=PC14,E1_EN=PA1,E1_DIR=PB6,E1_STEP=PA0,E2_EN=PC4,E2_DIR=PB11,E2_STEP=PB2,LCD_D6=PE9,LCD_D5=PE8,LCD_D10=PE13,LCD_D9=PE12,T_PEN=PE6,LCD_D11=PE14,LCD_D13=PD8,LCD_D14=PD9,LCD_D15=PD10,LCD_D12=PE15
aliases_probes: X_MIN=PE5,X_MAX=PE4,Y_MIN=PE3,Y_MAX=PE2,Z_MIN=PE1,Z_MAX=PE0
aliases_temp: E0_TEMP=PC0,T0_PWM=PB4,E1_TEMP=PC1,T1_PWM=PB5,E2_TEMP=PC2,T2_PWM=PB0,BED_TEMP=PC3,BED_PWM=PB1
aliases_other: FAN0_PWM=PB7,FAN1_PWM=PB8,FAN2_PWM=PB9,BEEP=PB10,LED_PWM=PD12
aliases_motors: X_EN=PA8,X_DIR=PD13,X_STEP=PC6,Y_EN=PA15,Y_DIR=PA11,Y_STEP=PA12,Z_EN=PB3,Z_DIR=PD3,Z_STEP=PD6,E0_EN=PC15,E0_DIR=PC13,E0_STEP=PC14,E1_EN=PA1,E1_DIR=PB6,E1_STEP=PA0,E2_EN=PC4,E2_DIR=PB11,E2_STEP=PB2
aliases_lcd: LCD_D0=PD14,LCD_D1=PD15,LCD_D2=PD0,LCD_D3=PD1,LCD_D4=PE7,LCD_D5=PE8,LCD_D6=PE9,LCD_D7=PE10,LCD_D8=PE11,LCD_D9=PE12,LCD_D10=PE13,LCD_D11=PE14,LCD_D12=PE15,LCD_D13=PD8,LCD_D14=PD9,LCD_D15=PD10,T_PEN=PE6,LCD_WR=PD5,LCD_RD=PD4,LCD_RS=PD11,LCD_CS=PD7,SPI2_MOSI=PB15,SPI2_MISO=PB14,SPI2_SCK=PB13,SPI2_NSS=PB12,SD_CD=PC7,SD_DATA0=PC8,SD_DATA1=PC9,SD_DATA2=PC10,SD_DATA3=PC11,SD_CLK=PC12,SD_CMD=PD2

[multi_pin heater]
pins: T0_PWM,T1_PWM,T2_PWM

[multi_pin printhead_fans]
pins: FAN1_PWM,FAN2_PWM

[thermistor bed_thermistor]
temperature1: 24
resistance1: 104600
temperature2: 40
resistance2: 47700
temperature3: 67
resistance3: 13000

[stepper_a]
step_pin: X_STEP
dir_pin: X_DIR
enable_pin: !X_EN
microsteps: 16
rotation_distance: 40
endstop_pin: ^X_MAX
homing_speed: 50
position_endstop: 216
arm_length: 201

[stepper_b]
step_pin: Y_STEP
dir_pin: Y_DIR
enable_pin: !Y_EN
microsteps: 16
rotation_distance: 40
endstop_pin: ^Y_MAX

[stepper_c]
step_pin: Z_STEP
dir_pin: Z_DIR
enable_pin: !Z_EN
microsteps: 16
rotation_distance: 40
endstop_pin: ^Z_MAX

[extruder]
step_pin: E0_STEP
dir_pin: !E0_DIR
enable_pin: !E0_EN
microsteps: 16
rotation_distance: 32
nozzle_diameter: 0.4
filament_diameter: 1.75
pressure_advance: 0.15
max_extrude_cross_section: 0.5
max_extrude_only_velocity: 30
max_extrude_only_accel: 500
heater_pin: multi_pin:heater
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 4700
inline_resistor: 220
sensor_pin: E0_TEMP
min_extrude_temp: 160
min_temp: 0
max_temp: 250

[extruder1]
step_pin: E1_STEP
dir_pin: !E1_DIR
enable_pin: !E1_EN
microsteps: 16
rotation_distance: 32
nozzle_diameter: 0.4
filament_diameter: 1.75
shared_heater: extruder

[extruder2]
step_pin: E2_STEP
dir_pin: !E2_DIR
enable_pin: !E2_EN
microsteps: 16
rotation_distance: 32
nozzle_diameter: 0.4
filament_diameter: 1.75
shared_heater: extruder

[heater_bed]
heater_pin: BED_PWM
sensor_type: bed_thermistor
sensor_pin: BED_TEMP
min_temp: 0
max_temp: 150

[temperature_sensor board]
sensor_type: temperature_mcu
gcode_id: MCU

[temperature_sensor secondary]
sensor_pin: E1_TEMP
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 4700
inline_resistor: 220
gcode_id: SEC

[temperature_sensor ambient]
sensor_pin: E0_TEMP
sensor_type: EPCOS 100K B57560G104F
pullup_resistor: 4700
inline_resistor: 220
gcode_id: AMB

[homing_heaters]
heaters: extruder

[fan]
pin: FAN0_PWM

[heater_fan printhead]
pin: multi_pin:printhead_fans
heater: extruder
max_power: 0.8
off_below: 0.2
shutdown_speed: 0

[mcu]
serial: /dev/serial/by-id/usb-FTDI_FT232R_USB_UART_AH06IBBC-if00-port0
restart_method: cheetah

[delta_calibrate]
radius: 65 #100

[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_radius: 70
mesh_origin: 0,0
round_probe_count: 3

[mixing_extruder]
steppers: extruder,extruder1,extruder2


[printer]
kinematics: delta
max_velocity: 300
max_accel: 3000
max_z_velocity: 150
delta_radius: 94

[output_pin beep]
pin: BEEP

[output_pin lcd_beep]
pin: LCD_D9

[gcode_arcs]
resolution: 0.1

[firmware_retraction]
retract_length: 5
retract_speed: 30

[probe]
pin: ^!Z_MIN
z_offset: 0.01
samples: 3
speed: 3
lift_speed: 7

[input_shaper]
shaper_freq_x: 30
shaper_freq_y: 30
shaper_type_x: zv
shaper_type_y: zv

[display]
lcd_type: hd44780
rs_pin: T_PEN
e_pin: LCD_D11
d4_pin: LCD_D13
d5_pin: LCD_D14
d6_pin: LCD_D15
d7_pin: LCD_D12
encoder_pins: ^LCD_D6,^LCD_D5
click_pin: ^LCD_D10

[save_variables]
filename: ~/variables.cfg

[pause_resume]
recover_velocity: 300

[gcode_macro PARK]
gcode:
  SAVE_GCODE_STATE NAME=toolchange
  {% if PRINTER["toolhead"].get_extruder().get_heater().get_temp() > 160 %}
    G90
    G1 Z190 F1000
    G1 X0 Y90 F1000
    G10
    G1 Z189 F10
  {% endif %}

[gcode_macro UNPARK]
gcode:
  {% if PRINTER["toolhead"].get_extruder().get_heater().get_temp() > 160 %}
    G11
    G1 X0 Y0 F1000
  {% endif %}
  RESTORE_GCODE_STATE NAME=toolchange MOVE=1

[gcode_macro T0]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T1]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder1
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder1"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T2]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder2
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder2"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T3]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder3
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder3"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T4]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder4
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder4"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T5]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder5
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder5"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T6]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder6
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder6"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro T7]
gcode:
  M117 switching tool
  {% if params.S|default(0)|int > 0 %}
    PARK
  {% endif %}
  ACTIVATE_EXTRUDER extruder=mixingextruder7
  SAVE_VARIABLE VARIABLE=currentextruder VALUE='"mixingextruder7"'
  {% if params.S|default(0)|int > 0 %}
    UNPARK
  {% endif %}

[gcode_macro START_GCODE]
gcode:
  {% set svv = printer.save_variables.variables %}
  ACTIVATE_EXTRUDER extruder={svv.currentextruder}
